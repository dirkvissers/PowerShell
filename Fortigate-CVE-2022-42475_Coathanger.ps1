<#
Dirk Vissers:
Using the Powershell PoshSSH-module to recusively scan for files within the directories that might give IoCs for CVE-2022-42475 and COATHANGER-malware.

Part 1 will be for CVE-2022-42475 IoC's:

    - Stage 1: Logdesc="Application crashed" and msg="[...] application: sslvpnd,[...], Signal 11 received, Backtrace: [...]“
    - Stage 2: Debug Crash-logs
    - Stage 3: Suspicious filesystem entries
    - Stage 4: Find malicious connections FROM the Fortigate

Part 2 will be for COATHANGER IoC's:

    - Stage 1: Suspicious filesystem entries
    - Stage 2: Diagnose active TCP Socket List for external IP's and the process that is using it (including PID)
    - Stage 3: Analyse the processes for anomalies, with extra attention to PID's captured in Stage 2
    - Stage 4: Generate hashes and compare them to known list of hashed related to COATHANGER

    #>

Install-Module -Name Posh-SSH -Force
Import-Module -Name Posh-SSH -Force

$creds = Get-Credential

##### Part 1: CVE-2022-42475 sslvpn heap-based buffer overflow IoC's

$Part1Session = New-SSHSession -ComputerName 192.168.1.99 -Credential $creds -AcceptKey

$Part1Stage1Stream = $Part1Session.Session.CreateShellStream("SSH-P1-ST1",0,0,0,0,2048)
$Part1Stage2Stream = $Part1Session.Session.CreateShellStream("SSH-P1-ST2",0,0,0,0,2048)
$Part1Stage3Stream = $Part1Session.Session.CreateShellStream("SSH-P1-ST3",0,0,0,0,2048)
$Part1Stage4Stream = $Part1Session.Session.CreateShellStream("SSH-P1-ST4",0,0,0,0,2048)

<# Stage 1: Scanning systemlogs for application crashes
Targets:
Logdesc="Application crashed" and msg="[...] application: sslvpnd,[...], Signal 11 received, Backtrace: [...]“

Tools:
FortiOS: Display logs in CLI when there's a match in criteria.

execute log filter category 1
execute log filter field logdesc 'Application crashed'
execute log filter field msg '*application: sslvpnd*'
execute log display
#>

Write-Host "Stage 1: Scanning systemlogs for application crashes" -ForegroundColor Yellow
Invoke-SSHStreamShellCommand -ShellStream $Part1Stage1Stream -Command "execute log filter category 1"
Invoke-SSHStreamShellCommand -ShellStream $Part1Stage1Stream -Command "execute log filter field logdesc 'Application crashed'"
Invoke-SSHStreamShellCommand -ShellStream $Part1Stage1Stream -Command "execute log filter field msg '*application: sslvpnd*'"
$Part1Stage1Output = Invoke-SSHStreamShellCommand -ShellStream $Part1Stage1Stream -Command "execute log display"

if(($Part1Stage1Output | Where-Object {$_ -ne ""}) -match "0 logs returned"){Write-Host "No logs found in system log that matched the criteria!" -ForegroundColor Green}
else {Write-Host "Well, we've found something, let's check it out." -ForegroundColor Yellow}

<# Stage 2: Scanning of the crash debug logfiles
Targets:
Look for application sslvpnd crashes

Tools:
FortiOS: Display crashlog in CLI and analyse output with Powershell.

diagnose debug crashlog read
#>

Write-Host "Stage 2: Scanning of the crash debug logfiles" -ForegroundColor Yellow
$Part1Stage2Output = Invoke-SSHStreamShellCommand -ShellStream $Part1Stage2Stream -Command "diagnose debug crashlog read"
$CrashLogEntries = @("application sslvpnd","signal 11 (Segmentation fault) received")
$Part1Stage2MatchingLines=$Part1Stage2Output | Select-String -SimpleMatch -List $CrashLogEntries
$Part1Stage2MatchingLines

<# Stage 3: Scan for Suspicious filesystem entries
Targets:
https://community.fortinet.com/t5/FortiGate/Technical-Tip-Critical-vulnerability-Protect-against-heap-based/ta-p/239420
Dir:/data/lib 
    /data/lib/libips.bak
    /data/lib/libgif.so
    /data/lib/libiptcp.so
    /data/lib/libipudp.so
    /data/lib/libjepg.so
Dir:/var
    /var/.sslvpnconfigbk
Dir:/data/etc
    /data/etc/wxd.conf
Dir:/
    /flash

Tools:
FortiOS: Using fortinet system control (fnsysctl) ls-cmdlet with -la parameter for showing hidden files and folders.

fnsysctl ls -la /data/lib
fnsysctl ls -la /var
fnsysctl ls -la /data/etc
fnsysctl ls -la /
#>

Write-Host "Stage 3: Scan for Suspicious filesystem entries" -ForegroundColor Yellow

$Part1Stage3MatchingFilenames = @("libips.bak","libgif.so","libiptcp.so","libipudp.so","libjepg.so",".sslvpnconfigbk","wxd.conf")

$Part1Stage3Output = Invoke-SSHStreamShellCommand -ShellStream $Part1Stage3Stream -Command "fnsysctl ls -la /data/lib"
$Part1Stage3Output += Invoke-SSHStreamShellCommand -ShellStream $Part1Stage3Stream -Command "fnsysctl ls -la /var"
$Part1Stage3Output += Invoke-SSHStreamShellCommand -ShellStream $Part1Stage3Stream -Command "fnsysctl ls -la /data/etc"
$Part1Stage3Output += Invoke-SSHStreamShellCommand -ShellStream $Part1Stage3Stream -Command "fnsysctl ls -la /"
$Part1Stage3MatchingLines = $Part1Stage3Output| Select-String -SimpleMatch -List $Part1Stage3MatchingFilenames
$Part1Stage3MatchingLines

<# Stage 4: Find malicious connections FROM the Fortigate
Targets:
https://www.fortinet.com/blog/psirt-blogs/analysis-of-fg-ir-22-398-fortios-heap-based-buffer-overflow-in-sslvpnd
IP/Domains
High Confidence
188.34.130.40       (port 444 observed)
103.131.189.143     (ports 30080,30081,30443,20443 observed)
193.36.119.61       (ports 8443,444 observed)
172.247.168.153     (port 8033 observed)
139.180.184.197
66.42.91.32
158.247.221.101
107.148.27.117
139.180.128.142
155.138.224.122
185.174.136.20
139.180.184.197
66.42.91.32
158.247.221.101
107.148.27.117
139.180.128.142
155.138.224.122
185.174.136.20
45.86.229.220
45.86.231.71
139.99.35.116
139.99.37.119
194.62.42.105
45.86.231.71
45.86.229.220
185.250.149.32
137.175.30.138
146.70.157.133

Older Actor IPs
156.251.162.76
156.251.163.122
156.251.163.19
156.251.162.111

Tools:
FortiOS: Use the Fortigate equivalant of netstat: diagnose sys tcpsock
#>

diagnose sys tcpsock



Remove-SSHSession -SSHSession $Part1Session

##### End of Part 1.

##### Part 2: COATHANGER-Malware


<# Stage 3: Analyse the processes for anomalies, with extra attention to PID's captured in Stage 2

Targets:



Tools:

Get all running processes:
fnsysctl ps

Get all PID's of a specific processname:
diagnose sys process pidof httpsd

#>